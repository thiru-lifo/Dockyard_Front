import { EventEmitter, Inject, Injectable, NgZone, Optional, PLATFORM_ID } from '@angular/core';
import { IdleExpiry } from './idleexpiry';
import { Interrupt } from './interrupt';
import { KeepaliveSvc } from './keepalivesvc';
import { LocalStorageExpiry } from './localstorageexpiry';
/*
 * Indicates the desired auto resume behavior.
 */
export var AutoResume;
(function (AutoResume) {
    /*
     * Auto resume functionality will be disabled.
     */
    AutoResume[AutoResume["disabled"] = 0] = "disabled";
    /*
     * Can resume automatically even if they are idle.
     */
    AutoResume[AutoResume["idle"] = 1] = "idle";
    /*
     * Can only resume automatically if they are not yet idle.
     */
    AutoResume[AutoResume["notIdle"] = 2] = "notIdle";
})(AutoResume || (AutoResume = {}));
/**
 * A service for detecting and responding to user idleness.
 */
export class Idle {
    constructor(expiry, zone, keepaliveSvc, 
    // tslint:disable-next-line: ban-types platform id injection will fail with any other type
    platformId) {
        this.expiry = expiry;
        this.zone = zone;
        this.platformId = platformId;
        this.idle = 20 * 60; // in seconds
        this.timeoutVal = 30; // in seconds
        this.autoResume = AutoResume.idle;
        this.interrupts = new Array();
        this.running = false;
        this.keepaliveEnabled = false;
        this.onIdleStart = new EventEmitter();
        this.onIdleEnd = new EventEmitter();
        this.onTimeoutWarning = new EventEmitter();
        this.onTimeout = new EventEmitter();
        this.onInterrupt = new EventEmitter();
        if (keepaliveSvc) {
            this.keepaliveSvc = keepaliveSvc;
            this.keepaliveEnabled = true;
        }
        this.setIdling(false);
    }
    /*
     * Sets the idle name for localStorage.
     * Important to set if multiple instances of Idle with LocalStorageExpiry
     * @param The name of the idle.
     */
    setIdleName(key) {
        if (this.expiry instanceof LocalStorageExpiry) {
            this.expiry.setIdleName(key);
        }
        else {
            throw new Error('Cannot set expiry key name because no LocalStorageExpiry has been provided.');
        }
    }
    /*
     * Returns whether or not keepalive integration is enabled.
     * @return True if integration is enabled; otherwise, false.
     */
    getKeepaliveEnabled() {
        return this.keepaliveEnabled;
    }
    /*
     * Sets and returns whether or not keepalive integration is enabled.
     * @param True if the integration is enabled; otherwise, false.
     * @return The current value.
     */
    setKeepaliveEnabled(value) {
        if (!this.keepaliveSvc) {
            throw new Error('Cannot enable keepalive integration because no KeepaliveSvc has been provided.');
        }
        return (this.keepaliveEnabled = value);
    }
    /*
     * Returns the current timeout value.
     * @return The timeout value in seconds.
     */
    getTimeout() {
        return this.timeoutVal;
    }
    /*
     * Sets the timeout value.
     * @param seconds - The timeout value in seconds. 0 or false to disable timeout feature.
     * @return The current value. If disabled, the value will be 0.
     */
    setTimeout(seconds) {
        if (seconds === false) {
            this.timeoutVal = 0;
        }
        else if (typeof seconds === 'number' && seconds >= 0) {
            this.timeoutVal = seconds;
        }
        else {
            throw new Error("'seconds' can only be 'false' or a positive number.");
        }
        return this.timeoutVal;
    }
    /*
     * Returns the current idle value.
     * @return The idle value in seconds.
     */
    getIdle() {
        return this.idle;
    }
    /*
     * Sets the idle value.
     * @param seconds - The idle value in seconds.
     * @return The idle value in seconds.
     */
    setIdle(seconds) {
        if (seconds <= 0) {
            throw new Error("'seconds' must be greater zero");
        }
        return (this.idle = seconds);
    }
    /*
     * Returns the current autoresume value.
     * @return The current value.
     */
    getAutoResume() {
        return this.autoResume;
    }
    setAutoResume(value) {
        return (this.autoResume = value);
    }
    /*
     * Sets interrupts from the specified sources.
     * @param sources - Interrupt sources.
     * @return The resulting interrupts.
     */
    setInterrupts(sources) {
        this.clearInterrupts();
        const self = this;
        for (const source of sources) {
            const options = { platformId: this.platformId };
            const sub = new Interrupt(source, options);
            sub.subscribe((args) => {
                self.interrupt(args.force, args.innerArgs);
            });
            this.interrupts.push(sub);
        }
        return this.interrupts;
    }
    /*
     * Returns the current interrupts.
     * @return The current interrupts.
     */
    getInterrupts() {
        return this.interrupts;
    }
    /*
     * Pauses, unsubscribes, and clears the current interrupt subscriptions.
     */
    clearInterrupts() {
        for (const sub of this.interrupts) {
            sub.pause();
            sub.unsubscribe();
        }
        this.interrupts.length = 0;
    }
    /*
     * Returns whether or not the service is running i.e. watching for idleness.
     * @return True if service is watching; otherwise, false.
     */
    isRunning() {
        return this.running;
    }
    /*
     * Returns whether or not the user is considered idle.
     * @return True if the user is in the idle state; otherwise, false.
     */
    isIdling() {
        return this.idling;
    }
    /*
     * Starts watching for inactivity.
     */
    watch(skipExpiry) {
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        const timeout = !this.timeoutVal ? 0 : this.timeoutVal;
        if (!skipExpiry) {
            const value = new Date(this.expiry.now().getTime() + (this.idle + timeout) * 1000);
            this.expiry.last(value);
        }
        if (this.idling) {
            this.toggleState();
        }
        if (!this.running) {
            this.startKeepalive();
            this.toggleInterrupts(true);
        }
        this.running = true;
        const watchFn = () => {
            this.zone.run(() => {
                const diff = this.getExpiryDiff(timeout);
                if (diff > 0) {
                    this.safeClearInterval('idleHandle');
                    this.setIdleIntervalOutsideOfZone(watchFn, diff);
                }
                else {
                    this.toggleState();
                }
            });
        };
        this.setIdleIntervalOutsideOfZone(watchFn, this.idle * 1000);
    }
    /*
     * Allows protractor tests to call waitForAngular without hanging
     */
    setIdleIntervalOutsideOfZone(watchFn, frequency) {
        this.zone.runOutsideAngular(() => {
            this.idleHandle = setInterval(watchFn, frequency);
        });
    }
    /*
     * Stops watching for inactivity.
     */
    stop() {
        this.stopKeepalive();
        this.toggleInterrupts(false);
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        this.setIdling(false);
        this.running = false;
        this.expiry.last(null);
    }
    /*
     * Forces a timeout event and state.
     */
    timeout() {
        this.stopKeepalive();
        this.toggleInterrupts(false);
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        this.setIdling(true);
        this.running = false;
        this.countdown = 0;
        this.onTimeout.emit(null);
    }
    /*
     * Signals that user activity has occurred.
     * @param force - Forces watch to be called, unless they are timed out.
     * @param eventArgs - Optional source event arguments.
     */
    interrupt(force, eventArgs) {
        if (!this.running) {
            return;
        }
        if (this.timeoutVal && this.expiry.isExpired()) {
            this.timeout();
            return;
        }
        this.onInterrupt.emit(eventArgs);
        if (force === true ||
            this.autoResume === AutoResume.idle ||
            (this.autoResume === AutoResume.notIdle && !this.expiry.idling())) {
            this.watch(force);
        }
    }
    setIdling(value) {
        this.idling = value;
        this.expiry.idling(value);
    }
    toggleState() {
        this.setIdling(!this.idling);
        if (this.idling) {
            this.onIdleStart.emit(null);
            this.stopKeepalive();
            if (this.timeoutVal > 0) {
                this.countdown = this.timeoutVal;
                this.doCountdown();
                this.setTimoutIntervalOutsideZone(() => {
                    this.doCountdownInZone();
                }, 1000);
            }
        }
        else {
            this.toggleInterrupts(true);
            this.onIdleEnd.emit(null);
            this.startKeepalive();
        }
        this.safeClearInterval('idleHandle');
    }
    setTimoutIntervalOutsideZone(intervalFn, frequency) {
        this.zone.runOutsideAngular(() => {
            this.timeoutHandle = setInterval(() => {
                intervalFn();
            }, frequency);
        });
    }
    toggleInterrupts(resume) {
        for (const interrupt of this.interrupts) {
            if (resume) {
                interrupt.resume();
            }
            else {
                interrupt.pause();
            }
        }
    }
    getExpiryDiff(timeout) {
        const now = this.expiry.now();
        const last = this.expiry.last() || now;
        return last.getTime() - now.getTime() - timeout * 1000;
    }
    doCountdownInZone() {
        this.zone.run(() => {
            this.doCountdown();
        });
    }
    doCountdown() {
        const diff = this.getExpiryDiff(this.timeoutVal);
        if (diff > 0) {
            this.safeClearInterval('timeoutHandle');
            this.interrupt(true);
            return;
        }
        if (!this.idling) {
            return;
        }
        if (this.countdown <= 0) {
            this.timeout();
            return;
        }
        this.onTimeoutWarning.emit(this.countdown);
        this.countdown--;
    }
    safeClearInterval(handleName) {
        const handle = this[handleName];
        if (handle !== null && typeof handle !== 'undefined') {
            clearInterval(this[handleName]);
            this[handleName] = null;
        }
    }
    startKeepalive() {
        if (!this.keepaliveSvc || !this.keepaliveEnabled) {
            return;
        }
        if (this.running) {
            this.keepaliveSvc.ping();
        }
        this.keepaliveSvc.start();
    }
    stopKeepalive() {
        if (!this.keepaliveSvc || !this.keepaliveEnabled) {
            return;
        }
        this.keepaliveSvc.stop();
    }
    /*
     * Called by Angular when destroying the instance.
     */
    ngOnDestroy() {
        this.stop();
        this.clearInterrupts();
    }
}
Idle.decorators = [
    { type: Injectable }
];
Idle.ctorParameters = () => [
    { type: IdleExpiry },
    { type: NgZone },
    { type: KeepaliveSvc, decorators: [{ type: Optional }] },
    { type: Object, decorators: [{ type: Optional }, { type: Inject, args: [PLATFORM_ID,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2NvcmUvc3JjL2xpYi9pZGxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxZQUFZLEVBQ1osTUFBTSxFQUNOLFVBQVUsRUFDVixNQUFNLEVBRU4sUUFBUSxFQUNSLFdBQVcsRUFDWixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFHeEMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTFEOztHQUVHO0FBQ0gsTUFBTSxDQUFOLElBQVksVUFhWDtBQWJELFdBQVksVUFBVTtJQUNwQjs7T0FFRztJQUNILG1EQUFRLENBQUE7SUFDUjs7T0FFRztJQUNILDJDQUFJLENBQUE7SUFDSjs7T0FFRztJQUNILGlEQUFPLENBQUE7QUFDVCxDQUFDLEVBYlcsVUFBVSxLQUFWLFVBQVUsUUFhckI7QUFFRDs7R0FFRztBQUVILE1BQU0sT0FBTyxJQUFJO0lBcUJmLFlBQ1UsTUFBa0IsRUFDbEIsSUFBWSxFQUNSLFlBQTJCO0lBQ3ZDLDBGQUEwRjtJQUNqRCxVQUFtQjtRQUpwRCxXQUFNLEdBQU4sTUFBTSxDQUFZO1FBQ2xCLFNBQUksR0FBSixJQUFJLENBQVE7UUFHcUIsZUFBVSxHQUFWLFVBQVUsQ0FBUztRQXpCdEQsU0FBSSxHQUFXLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxhQUFhO1FBQ3JDLGVBQVUsR0FBRyxFQUFFLENBQUMsQ0FBQyxhQUFhO1FBQzlCLGVBQVUsR0FBZSxVQUFVLENBQUMsSUFBSSxDQUFDO1FBQ3pDLGVBQVUsR0FBcUIsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUMzQyxZQUFPLEdBQUcs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RUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFTyxhQUFhO1FBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ2hELE9BQU87U0FDUjtRQUVELElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsV0FBVztRQUNULElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNaLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUN6QixDQUFDOzs7WUFoYUYsVUFBVTs7O1lBNUJGLFVBQVU7WUFOakIsTUFBTTtZQVVDLFlBQVksdUJBaURoQixRQUFRO1lBRTZDLE1BQU0sdUJBQTNELFFBQVEsWUFBSSxNQUFNLFNBQUMsV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEV2ZW50RW1pdHRlcixcbiAgSW5qZWN0LFxuICBJbmplY3RhYmxlLFxuICBOZ1pvbmUsXG4gIE9uRGVzdHJveSxcbiAgT3B0aW9uYWwsXG4gIFBMQVRGT1JNX0lEXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBJZGxlRXhwaXJ5IH0gZnJvbSAnLi9pZGxlZXhwaXJ5JztcbmltcG9ydCB7IEludGVycnVwdCB9IGZyb20gJy4vaW50ZXJydXB0JztcbmltcG9ydCB7IEludGVycnVwdEFyZ3MgfSBmcm9tICcuL2ludGVycnVwdGFyZ3MnO1xuaW1wb3J0IHsgSW50ZXJydXB0U291cmNlIH0gZnJvbSAnLi9pbnRlcnJ1cHRzb3VyY2UnO1xuaW1wb3J0IHsgS2VlcGFsaXZlU3ZjIH0gZnJvbSAnLi9rZWVwYWxpdmVzdmMnO1xuaW1wb3J0IHsgTG9jYWxTdG9yYWdlRXhwaXJ5IH0gZnJvbSAnLi9sb2NhbHN0b3JhZ2VleHBpcnknO1xuXG4vKlxuICogSW5kaWNhdGVzIHRoZSBkZXNpcmVkIGF1dG8gcmVzdW1lIGJlaGF2aW9yLlxuICovXG5leHBvcnQgZW51bSBBdXRvUmVzdW1lIHtcbiAgLypcbiAgICogQXV0byByZXN1bWUgZnVuY3Rpb25hbGl0eSB3aWxsIGJlIGRpc2FibGVkLlxuICAgKi9cbiAgZGlzYWJsZWQsXG4gIC8qXG4gICAqIENhbiByZXN1bWUgYXV0b21hdGljYWxseSBldmVuIGlmIHRoZXkgYXJlIGlkbGUuXG4gICAqL1xuICBpZGxlLFxuICAvKlxuICAgKiBDYW4gb25seSByZXN1bWUgYXV0b21hdGljYWxseSBpZiB0aGV5IGFyZSBub3QgeWV0IGlkbGUuXG4gICAqL1xuICBub3RJZGxlXG59XG5cbi8qKlxuICogQSBzZXJ2aWNlIGZvciBkZXRlY3RpbmcgYW5kIHJlc3BvbmRpbmcgdG8gdXNlciBpZGxlbmVzcy5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIElkbGUgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGlkbGU6IG51bWJlciA9IDIwICogNjA7IC8vIGluIHNlY29uZHNcbiAgcHJpdmF0ZSB0aW1lb3V0VmFsID0gMzA7IC8vIGluIHNlY29uZHNcbiAgcHJpdmF0ZSBhdXRvUmVzdW1lOiBBdXRvUmVzdW1lID0gQXV0b1Jlc3VtZS5pZGxlO1xuICBwcml2YXRlIGludGVycnVwdHM6IEFycmF5PEludGVycnVwdD4gPSBuZXcgQXJyYXkoKTtcbiAgcHJpdmF0ZSBydW5uaW5nID0gZmFsc2U7XG4gIHByaXZhdGUgaWRsaW5nOiBib29sZWFuO1xuICBwcml2YXRlIGlkbGVIYW5kbGU6IGFueTtcbiAgcHJpdmF0ZSB0aW1lb3V0SGFuZGxlOiBhbnk7XG4gIHByaXZhdGUgY291bnRkb3duOiBudW1iZXI7XG4gIHByaXZhdGUga2VlcGFsaXZlRW5hYmxlZCA9IGZhbHNlO1xuICBwcml2YXRlIGtlZXBhbGl2ZVN2YzogS2VlcGFsaXZlU3ZjO1xuXG4gIHB1YmxpYyBvbklkbGVTdGFydDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIHB1YmxpYyBvbklkbGVFbmQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBwdWJsaWMgb25UaW1lb3V0V2FybmluZzogRXZlbnRFbWl0dGVyPG51bWJlcj4gPSBuZXcgRXZlbnRFbWl0dGVyPG51bWJlcj4oKTtcbiAgcHVibGljIG9uVGltZW91dDogRXZlbnRFbWl0dGVyPG51bWJlcj4gPSBuZXcgRXZlbnRFbWl0dGVyPG51bWJlcj4oKTtcbiAgcHVibGljIG9uSW50ZXJydXB0OiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBba2V5OiBzdHJpbmddOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBleHBpcnk6IElkbGVFeHBpcnksXG4gICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsXG4gICAgQE9wdGlvbmFsKCkga2VlcGFsaXZlU3ZjPzogS2VlcGFsaXZlU3ZjLFxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogYmFuLXR5cGVzIHBsYXRmb3JtIGlkIGluamVjdGlvbiB3aWxsIGZhaWwgd2l0aCBhbnkgb3RoZXIgdHlwZVxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1JZD86IE9iamVjdFxuICApIHtcbiAgICBpZiAoa2VlcGFsaXZlU3ZjKSB7XG4gICAgICB0aGlzLmtlZXBhbGl2ZVN2YyA9IGtlZXBhbGl2ZVN2YztcbiAgICAgIHRoaXMua2VlcGFsaXZlRW5hYmxlZCA9IHRydWU7XG4gICAgfVxuICAgIHRoaXMuc2V0SWRsaW5nKGZhbHNlKTtcbiAgfVxuXG4gIC8qXG4gICAqIFNldHMgdGhlIGlkbGUgbmFtZSBmb3IgbG9jYWxTdG9yYWdlLlxuICAgKiBJbXBvcnRhbnQgdG8gc2V0IGlmIG11bHRpcGxlIGluc3RhbmNlcyBvZiBJZGxlIHdpdGggTG9jYWxTdG9yYWdlRXhwaXJ5XG4gICAqIEBwYXJhbSBUaGUgbmFtZSBvZiB0aGUgaWRsZS5cbiAgICovXG4gIHNldElkbGVOYW1lKGtleTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZXhwaXJ5IGluc3RhbmNlb2YgTG9jYWxTdG9yYWdlRXhwaXJ5KSB7XG4gICAgICB0aGlzLmV4cGlyeS5zZXRJZGxlTmFtZShrZXkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdDYW5ub3Qgc2V0IGV4cGlyeSBrZXkgbmFtZSBiZWNhdXNlIG5vIExvY2FsU3RvcmFnZUV4cGlyeSBoYXMgYmVlbiBwcm92aWRlZC4nXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgd2hldGhlciBvciBub3Qga2VlcGFsaXZlIGludGVncmF0aW9uIGlzIGVuYWJsZWQuXG4gICAqIEByZXR1cm4gVHJ1ZSBpZiBpbnRlZ3JhdGlvbiBpcyBlbmFibGVkOyBvdGhlcndpc2UsIGZhbHNlLlxuICAgKi9cbiAgZ2V0S2VlcGFsaXZlRW5hYmxlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5rZWVwYWxpdmVFbmFibGVkO1xuICB9XG5cbiAgLypcbiAgICogU2V0cyBhbmQgcmV0dXJucyB3aGV0aGVyIG9yIG5vdCBrZWVwYWxpdmUgaW50ZWdyYXRpb24gaXMgZW5hYmxlZC5cbiAgICogQHBhcmFtIFRydWUgaWYgdGhlIGludGVncmF0aW9uIGlzIGVuYWJsZWQ7IG90aGVyd2lzZSwgZmFsc2UuXG4gICAqIEByZXR1cm4gVGhlIGN1cnJlbnQgdmFsdWUuXG4gICAqL1xuICBzZXRLZWVwYWxpdmVFbmFibGVkKHZhbHVlOiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgaWYgKCF0aGlzLmtlZXBhbGl2ZVN2Yykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnQ2Fubm90IGVuYWJsZSBrZWVwYWxpdmUgaW50ZWdyYXRpb24gYmVjYXVzZSBubyBLZWVwYWxpdmVTdmMgaGFzIGJlZW4gcHJvdmlkZWQuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gKHRoaXMua2VlcGFsaXZlRW5hYmxlZCA9IHZhbHVlKTtcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgdGhlIGN1cnJlbnQgdGltZW91dCB2YWx1ZS5cbiAgICogQHJldHVybiBUaGUgdGltZW91dCB2YWx1ZSBpbiBzZWNvbmRzLlxuICAgKi9cbiAgZ2V0VGltZW91dCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnRpbWVvdXRWYWw7XG4gIH1cblxuICAvKlxuICAgKiBTZXRzIHRoZSB0aW1lb3V0IHZhbHVlLlxuICAgKiBAcGFyYW0gc2Vjb25kcyAtIFRoZSB0aW1lb3V0IHZhbHVlIGluIHNlY29uZHMuIDAgb3IgZmFsc2UgdG8gZGlzYWJsZSB0aW1lb3V0IGZlYXR1cmUuXG4gICAqIEByZXR1cm4gVGhlIGN1cnJlbnQgdmFsdWUuIElmIGRpc2FibGVkLCB0aGUgdmFsdWUgd2lsbCBiZSAwLlxuICAgKi9cbiAgc2V0VGltZW91dChzZWNvbmRzOiBudW1iZXIgfCBib29sZWFuKTogbnVtYmVyIHtcbiAgICBpZiAoc2Vjb25kcyA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMudGltZW91dFZhbCA9IDA7XG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygc2Vjb25kcyA9PT0gJ251bWJlcicgJiYgc2Vjb25kcyA+PSAwKSB7XG4gICAgICB0aGlzLnRpbWVvdXRWYWwgPSBzZWNvbmRzO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCInc2Vjb25kcycgY2FuIG9ubHkgYmUgJ2ZhbHNlJyBvciBhIHBvc2l0aXZlIG51bWJlci5cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudGltZW91dFZhbDtcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgdGhlIGN1cnJlbnQgaWRsZSB2YWx1ZS5cbiAgICogQHJldHVybiBUaGUgaWRsZSB2YWx1ZSBpbiBzZWNvbmRzLlxuICAgKi9cbiAgZ2V0SWRsZSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmlkbGU7XG4gIH1cblxuICAvKlxuICAgKiBTZXRzIHRoZSBpZGxlIHZhbHVlLlxuICAgKiBAcGFyYW0gc2Vjb25kcyAtIFRoZSBpZGxlIHZhbHVlIGluIHNlY29uZHMuXG4gICAqIEByZXR1cm4gVGhlIGlkbGUgdmFsdWUgaW4gc2Vjb25kcy5cbiAgICovXG4gIHNldElkbGUoc2Vjb25kczogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBpZiAoc2Vjb25kcyA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCInc2Vjb25kcycgbXVzdCBiZSBncmVhdGVyIHplcm9cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuICh0aGlzLmlkbGUgPSBzZWNvbmRzKTtcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgdGhlIGN1cnJlbnQgYXV0b3Jlc3VtZSB2YWx1ZS5cbiAgICogQHJldHVybiBUaGUgY3VycmVudCB2YWx1ZS5cbiAgICovXG4gIGdldEF1dG9SZXN1bWUoKTogQXV0b1Jlc3VtZSB7XG4gICAgcmV0dXJuIHRoaXMuYXV0b1Jlc3VtZTtcbiAgfVxuXG4gIHNldEF1dG9SZXN1bWUodmFsdWU6IEF1dG9SZXN1bWUpOiBBdXRvUmVzdW1lIHtcbiAgICByZXR1cm4gKHRoaXMuYXV0b1Jlc3VtZSA9IHZhbHVlKTtcbiAgfVxuXG4gIC8qXG4gICAqIFNldHMgaW50ZXJydXB0cyBmcm9tIHRoZSBzcGVjaWZpZWQgc291cmNlcy5cbiAgICogQHBhcmFtIHNvdXJjZXMgLSBJbnRlcnJ1cHQgc291cmNlcy5cbiAgICogQHJldHVybiBUaGUgcmVzdWx0aW5nIGludGVycnVwdHMuXG4gICAqL1xuICBzZXRJbnRlcnJ1cHRzKHNvdXJjZXM6IEFycmF5PEludGVycnVwdFNvdXJjZT4pOiBBcnJheTxJbnRlcnJ1cHQ+IHtcbiAgICB0aGlzLmNsZWFySW50ZXJydXB0cygpO1xuXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICBmb3IgKGNvbnN0IHNvdXJjZSBvZiBzb3VyY2VzKSB7XG4gICAgICBjb25zdCBvcHRpb25zID0geyBwbGF0Zm9ybUlkOiB0aGlzLnBsYXRmb3JtSWQgfTtcbiAgICAgIGNvbnN0IHN1YiA9IG5ldyBJbnRlcnJ1cHQoc291cmNlLCBvcHRpb25zKTtcbiAgICAgIHN1Yi5zdWJzY3JpYmUoKGFyZ3M6IEludGVycnVwdEFyZ3MpID0+IHtcbiAgICAgICAgc2VsZi5pbnRlcnJ1cHQoYXJncy5mb3JjZSwgYXJncy5pbm5lckFyZ3MpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuaW50ZXJydXB0cy5wdXNoKHN1Yik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuaW50ZXJydXB0cztcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgdGhlIGN1cnJlbnQgaW50ZXJydXB0cy5cbiAgICogQHJldHVybiBUaGUgY3VycmVudCBpbnRlcnJ1cHRzLlxuICAgKi9cbiAgZ2V0SW50ZXJydXB0cygpOiBBcnJheTxJbnRlcnJ1cHQ+IHtcbiAgICByZXR1cm4gdGhpcy5pbnRlcnJ1cHRzO1xuICB9XG5cbiAgLypcbiAgICogUGF1c2VzLCB1bnN1YnNjcmliZXMsIGFuZCBjbGVhcnMgdGhlIGN1cnJlbnQgaW50ZXJydXB0IHN1YnNjcmlwdGlvbnMuXG4gICAqL1xuICBjbGVhckludGVycnVwdHMoKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBzdWIgb2YgdGhpcy5pbnRlcnJ1cHRzKSB7XG4gICAgICBzdWIucGF1c2UoKTtcbiAgICAgIHN1Yi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIHRoaXMuaW50ZXJydXB0cy5sZW5ndGggPSAwO1xuICB9XG5cbiAgLypcbiAgICogUmV0dXJucyB3aGV0aGVyIG9yIG5vdCB0aGUgc2VydmljZSBpcyBydW5uaW5nIGkuZS4gd2F0Y2hpbmcgZm9yIGlkbGVuZXNzLlxuICAgKiBAcmV0dXJuIFRydWUgaWYgc2VydmljZSBpcyB3YXRjaGluZzsgb3RoZXJ3aXNlLCBmYWxzZS5cbiAgICovXG4gIGlzUnVubmluZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5ydW5uaW5nO1xuICB9XG5cbiAgLypcbiAgICogUmV0dXJucyB3aGV0aGVyIG9yIG5vdCB0aGUgdXNlciBpcyBjb25zaWRlcmVkIGlkbGUuXG4gICAqIEByZXR1cm4gVHJ1ZSBpZiB0aGUgdXNlciBpcyBpbiB0aGUgaWRsZSBzdGF0ZTsgb3RoZXJ3aXNlLCBmYWxzZS5cbiAgICovXG4gIGlzSWRsaW5nKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlkbGluZztcbiAgfVxuXG4gIC8qXG4gICAqIFN0YXJ0cyB3YXRjaGluZyBmb3IgaW5hY3Rpdml0eS5cbiAgICovXG4gIHdhdGNoKHNraXBFeHBpcnk/OiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgnaWRsZUhhbmRsZScpO1xuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ3RpbWVvdXRIYW5kbGUnKTtcblxuICAgIGNvbnN0IHRpbWVvdXQgPSAhdGhpcy50aW1lb3V0VmFsID8gMCA6IHRoaXMudGltZW91dFZhbDtcbiAgICBpZiAoIXNraXBFeHBpcnkpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gbmV3IERhdGUoXG4gICAgICAgIHRoaXMuZXhwaXJ5Lm5vdygpLmdldFRpbWUoKSArICh0aGlzLmlkbGUgKyB0aW1lb3V0KSAqIDEwMDBcbiAgICAgICk7XG4gICAgICB0aGlzLmV4cGlyeS5sYXN0KHZhbHVlKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pZGxpbmcpIHtcbiAgICAgIHRoaXMudG9nZ2xlU3RhdGUoKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnJ1bm5pbmcpIHtcbiAgICAgIHRoaXMuc3RhcnRLZWVwYWxpdmUoKTtcbiAgICAgIHRoaXMudG9nZ2xlSW50ZXJydXB0cyh0cnVlKTtcbiAgICB9XG5cbiAgICB0aGlzLnJ1bm5pbmcgPSB0cnVlO1xuXG4gICAgY29uc3Qgd2F0Y2hGbiA9ICgpID0+IHtcbiAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgICBjb25zdCBkaWZmID0gdGhpcy5nZXRFeHBpcnlEaWZmKHRpbWVvdXQpO1xuICAgICAgICBpZiAoZGlmZiA+IDApIHtcbiAgICAgICAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCdpZGxlSGFuZGxlJyk7XG4gICAgICAgICAgdGhpcy5zZXRJZGxlSW50ZXJ2YWxPdXRzaWRlT2Zab25lKHdhdGNoRm4sIGRpZmYpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMudG9nZ2xlU3RhdGUoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfTtcblxuICAgIHRoaXMuc2V0SWRsZUludGVydmFsT3V0c2lkZU9mWm9uZSh3YXRjaEZuLCB0aGlzLmlkbGUgKiAxMDAwKTtcbiAgfVxuXG4gIC8qXG4gICAqIEFsbG93cyBwcm90cmFjdG9yIHRlc3RzIHRvIGNhbGwgd2FpdEZvckFuZ3VsYXIgd2l0aG91dCBoYW5naW5nXG4gICAqL1xuICBzZXRJZGxlSW50ZXJ2YWxPdXRzaWRlT2Zab25lKHdhdGNoRm46ICgpID0+IHZvaWQsIGZyZXF1ZW5jeTogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHRoaXMuaWRsZUhhbmRsZSA9IHNldEludGVydmFsKHdhdGNoRm4sIGZyZXF1ZW5jeSk7XG4gICAgfSk7XG4gIH1cblxuICAvKlxuICAgKiBTdG9wcyB3YXRjaGluZyBmb3IgaW5hY3Rpdml0eS5cbiAgICovXG4gIHN0b3AoKTogdm9pZCB7XG4gICAgdGhpcy5zdG9wS2VlcGFsaXZlKCk7XG5cbiAgICB0aGlzLnRvZ2dsZUludGVycnVwdHMoZmFsc2UpO1xuXG4gICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgnaWRsZUhhbmRsZScpO1xuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ3RpbWVvdXRIYW5kbGUnKTtcblxuICAgIHRoaXMuc2V0SWRsaW5nKGZhbHNlKTtcbiAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTtcblxuICAgIHRoaXMuZXhwaXJ5Lmxhc3QobnVsbCk7XG4gIH1cblxuICAvKlxuICAgKiBGb3JjZXMgYSB0aW1lb3V0IGV2ZW50IGFuZCBzdGF0ZS5cbiAgICovXG4gIHRpbWVvdXQoKTogdm9pZCB7XG4gICAgdGhpcy5zdG9wS2VlcGFsaXZlKCk7XG5cbiAgICB0aGlzLnRvZ2dsZUludGVycnVwdHMoZmFsc2UpO1xuXG4gICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgnaWRsZUhhbmRsZScpO1xuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ3RpbWVvdXRIYW5kbGUnKTtcblxuICAgIHRoaXMuc2V0SWRsaW5nKHRydWUpO1xuICAgIHRoaXMucnVubmluZyA9IGZhbHNlO1xuICAgIHRoaXMuY291bnRkb3duID0gMDtcblxuICAgIHRoaXMub25UaW1lb3V0LmVtaXQobnVsbCk7XG4gIH1cblxuICAvKlxuICAgKiBTaWduYWxzIHRoYXQgdXNlciBhY3Rpdml0eSBoYXMgb2NjdXJyZWQuXG4gICAqIEBwYXJhbSBmb3JjZSAtIEZvcmNlcyB3YXRjaCB0byBiZSBjYWxsZWQsIHVubGVzcyB0aGV5IGFyZSB0aW1lZCBvdXQuXG4gICAqIEBwYXJhbSBldmVudEFyZ3MgLSBPcHRpb25hbCBzb3VyY2UgZXZlbnQgYXJndW1lbnRzLlxuICAgKi9cbiAgaW50ZXJydXB0KGZvcmNlPzogYm9vbGVhbiwgZXZlbnRBcmdzPzogYW55KTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnJ1bm5pbmcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy50aW1lb3V0VmFsICYmIHRoaXMuZXhwaXJ5LmlzRXhwaXJlZCgpKSB7XG4gICAgICB0aGlzLnRpbWVvdXQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5vbkludGVycnVwdC5lbWl0KGV2ZW50QXJncyk7XG5cbiAgICBpZiAoXG4gICAgICBmb3JjZSA9PT0gdHJ1ZSB8fFxuICAgICAgdGhpcy5hdXRvUmVzdW1lID09PSBBdXRvUmVzdW1lLmlkbGUgfHxcbiAgICAgICh0aGlzLmF1dG9SZXN1bWUgPT09IEF1dG9SZXN1bWUubm90SWRsZSAmJiAhdGhpcy5leHBpcnkuaWRsaW5nKCkpXG4gICAgKSB7XG4gICAgICB0aGlzLndhdGNoKGZvcmNlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldElkbGluZyh2YWx1ZTogYm9vbGVhbik6IHZvaWQge1xuICAgIHRoaXMuaWRsaW5nID0gdmFsdWU7XG4gICAgdGhpcy5leHBpcnkuaWRsaW5nKHZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgdG9nZ2xlU3RhdGUoKTogdm9pZCB7XG4gICAgdGhpcy5zZXRJZGxpbmcoIXRoaXMuaWRsaW5nKTtcblxuICAgIGlmICh0aGlzLmlkbGluZykge1xuICAgICAgdGhpcy5vbklkbGVTdGFydC5lbWl0KG51bGwpO1xuICAgICAgdGhpcy5zdG9wS2VlcGFsaXZlKCk7XG5cbiAgICAgIGlmICh0aGlzLnRpbWVvdXRWYWwgPiAwKSB7XG4gICAgICAgIHRoaXMuY291bnRkb3duID0gdGhpcy50aW1lb3V0VmFsO1xuICAgICAgICB0aGlzLmRvQ291bnRkb3duKCk7XG4gICAgICAgIHRoaXMuc2V0VGltb3V0SW50ZXJ2YWxPdXRzaWRlWm9uZSgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5kb0NvdW50ZG93bkluWm9uZSgpO1xuICAgICAgICB9LCAxMDAwKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50b2dnbGVJbnRlcnJ1cHRzKHRydWUpO1xuICAgICAgdGhpcy5vbklkbGVFbmQuZW1pdChudWxsKTtcbiAgICAgIHRoaXMuc3RhcnRLZWVwYWxpdmUoKTtcbiAgICB9XG5cbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCdpZGxlSGFuZGxlJyk7XG4gIH1cblxuICBwcml2YXRlIHNldFRpbW91dEludGVydmFsT3V0c2lkZVpvbmUoXG4gICAgaW50ZXJ2YWxGbjogKCkgPT4gdm9pZCxcbiAgICBmcmVxdWVuY3k6IG51bWJlclxuICApIHtcbiAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgdGhpcy50aW1lb3V0SGFuZGxlID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICBpbnRlcnZhbEZuKCk7XG4gICAgICB9LCBmcmVxdWVuY3kpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB0b2dnbGVJbnRlcnJ1cHRzKHJlc3VtZTogYm9vbGVhbik6IHZvaWQge1xuICAgIGZvciAoY29uc3QgaW50ZXJydXB0IG9mIHRoaXMuaW50ZXJydXB0cykge1xuICAgICAgaWYgKHJlc3VtZSkge1xuICAgICAgICBpbnRlcnJ1cHQucmVzdW1lKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbnRlcnJ1cHQucGF1c2UoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEV4cGlyeURpZmYodGltZW91dDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBjb25zdCBub3c6IERhdGUgPSB0aGlzLmV4cGlyeS5ub3coKTtcbiAgICBjb25zdCBsYXN0OiBEYXRlID0gdGhpcy5leHBpcnkubGFzdCgpIHx8IG5vdztcbiAgICByZXR1cm4gbGFzdC5nZXRUaW1lKCkgLSBub3cuZ2V0VGltZSgpIC0gdGltZW91dCAqIDEwMDA7XG4gIH1cblxuICBwcml2YXRlIGRvQ291bnRkb3duSW5ab25lKCk6IHZvaWQge1xuICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgdGhpcy5kb0NvdW50ZG93bigpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkb0NvdW50ZG93bigpOiB2b2lkIHtcbiAgICBjb25zdCBkaWZmID0gdGhpcy5nZXRFeHBpcnlEaWZmKHRoaXMudGltZW91dFZhbCk7XG4gICAgaWYgKGRpZmYgPiAwKSB7XG4gICAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCd0aW1lb3V0SGFuZGxlJyk7XG4gICAgICB0aGlzLmludGVycnVwdCh0cnVlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaWRsaW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY291bnRkb3duIDw9IDApIHtcbiAgICAgIHRoaXMudGltZW91dCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMub25UaW1lb3V0V2FybmluZy5lbWl0KHRoaXMuY291bnRkb3duKTtcbiAgICB0aGlzLmNvdW50ZG93bi0tO1xuICB9XG5cbiAgcHJpdmF0ZSBzYWZlQ2xlYXJJbnRlcnZhbChoYW5kbGVOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBoYW5kbGUgPSB0aGlzW2hhbmRsZU5hbWVdO1xuICAgIGlmIChoYW5kbGUgIT09IG51bGwgJiYgdHlwZW9mIGhhbmRsZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpc1toYW5kbGVOYW1lXSk7XG4gICAgICB0aGlzW2hhbmRsZU5hbWVdID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0YXJ0S2VlcGFsaXZlKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5rZWVwYWxpdmVTdmMgfHwgIXRoaXMua2VlcGFsaXZlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJ1bm5pbmcpIHtcbiAgICAgIHRoaXMua2VlcGFsaXZlU3ZjLnBpbmcoKTtcbiAgICB9XG5cbiAgICB0aGlzLmtlZXBhbGl2ZVN2Yy5zdGFydCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdG9wS2VlcGFsaXZlKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5rZWVwYWxpdmVTdmMgfHwgIXRoaXMua2VlcGFsaXZlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMua2VlcGFsaXZlU3ZjLnN0b3AoKTtcbiAgfVxuXG4gIC8qXG4gICAqIENhbGxlZCBieSBBbmd1bGFyIHdoZW4gZGVzdHJveWluZyB0aGUgaW5zdGFuY2UuXG4gICAqL1xuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3AoKTtcbiAgICB0aGlzLmNsZWFySW50ZXJydXB0cygpO1xuICB9XG59XG4iXX0=